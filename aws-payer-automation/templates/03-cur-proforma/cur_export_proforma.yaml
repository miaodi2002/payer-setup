AWSTemplateFormatVersion: '2010-09-09'
Description: "Create Legacy CUR Export with Pro forma configuration"

Parameters:
  BillingGroupArn:
    Type: String
    Description: "ARN of the BillingGroup created in previous step"

Resources:
  # Lambdaæ‰§è¡Œè§’è‰²
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: LambdaCURExportRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CURAndS3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - organizations:DescribeOrganization
                  - organizations:DescribeAccount
                  - cur:PutReportDefinition
                  - cur:DescribeReportDefinitions
                  - cur:ModifyReportDefinition
                  - cur:DeleteReportDefinition
                  - s3:CreateBucket
                  - s3:PutBucketPolicy
                  - s3:PutBucketPublicAccessBlock
                  - s3:PutBucketVersioning
                  - s3:GetBucketLocation
                  - s3:ListBucket
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"

  # Lambdaå‡½æ•°
  CreateCURExportFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: CreateLegacyCURExport
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      Code:
        ZipFile: |
          import json
          import boto3
          import cfnresponse
          import time

          def lambda_handler(event, context):
              try:
                  if event['RequestType'] == 'Delete':
                      # åˆ é™¤æ—¶ä¸åˆ é™¤S3 Bucketå’ŒCURï¼Œé¿å…æ•°æ®ä¸¢å¤±
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      return

                  organizations = boto3.client('organizations')
                  cur = boto3.client('cur', region_name='us-east-1')  # CURåªèƒ½åœ¨us-east-1åˆ›å»º
                  s3 = boto3.client('s3', region_name='us-east-1')

                  billing_group_arn = event['ResourceProperties']['BillingGroupArn']

                  # 1. è·å–Master Account ID
                  org_info = organizations.describe_organization()
                  master_account_id = org_info['Organization']['MasterAccountId']
                  
                  print(f"Master Account ID: {master_account_id}")

                  # 2. åˆ›å»ºS3 Bucket
                  bucket_name = f"bip-cur-{master_account_id}"
                  bucket_region = create_s3_bucket(s3, bucket_name)
                  
                  print(f"S3 Bucket created: {bucket_name} in {bucket_region}")

                  # 3. è®¾ç½®S3 Bucket Policy
                  set_s3_bucket_policy(s3, bucket_name, master_account_id)
                  
                  # 4. åˆ›å»ºCUR Export
                  report_name = master_account_id
                  cur_arn = create_cur_export(cur, report_name, bucket_name, billing_group_arn)
                  
                  print(f"CUR Export created: {report_name}")

                  response_data = {
                      "BucketName": bucket_name,
                      "BucketRegion": bucket_region,
                      "ReportName": report_name,
                      "CURArn": cur_arn,
                      "BillingGroupArn": billing_group_arn,
                      "Message": "Legacy CUR Export created successfully (BillingGroup will be processed separately)"
                  }

                  cfnresponse.send(event, context, cfnresponse.SUCCESS, response_data)

              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {"Error": str(e)})

          def create_s3_bucket(s3, bucket_name):
              """åˆ›å»ºæˆ–é…ç½®S3 Bucket"""
              try:
                  bucket_exists = False
                  
                  # æ£€æŸ¥bucketæ˜¯å¦å·²å­˜åœ¨
                  try:
                      response = s3.head_bucket(Bucket=bucket_name)
                      print(f"âœ… Bucket {bucket_name} already exists")
                      bucket_exists = True
                  except Exception as head_error:
                      print(f"Bucket {bucket_name} does not exist, will create: {str(head_error)}")

                  # å¦‚æœbucketä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                  if not bucket_exists:
                      try:
                          print(f"Creating bucket {bucket_name} in us-east-1...")
                          s3.create_bucket(Bucket=bucket_name)
                          print(f"âœ… Successfully created bucket {bucket_name}")
                      except Exception as create_error:
                          error_msg = str(create_error)
                          if "BucketAlreadyExists" in error_msg or "BucketAlreadyOwnedByYou" in error_msg:
                              print(f"âœ… Bucket {bucket_name} already exists (detected during creation)")
                              bucket_exists = True
                          else:
                              print(f"âŒ Failed to create bucket: {error_msg}")
                              raise

                  # æ— è®ºbucketæ˜¯æ–°åˆ›å»ºçš„è¿˜æ˜¯å·²å­˜åœ¨çš„ï¼Œéƒ½ç¡®ä¿æ­£ç¡®é…ç½®
                  print(f"Configuring bucket {bucket_name} settings...")
                  
                  # è®¾ç½®å…¬å…±è®¿é—®é˜»æ­¢
                  try:
                      s3.put_public_access_block(
                          Bucket=bucket_name,
                          PublicAccessBlockConfiguration={
                              'BlockPublicAcls': True,
                              'IgnorePublicAcls': True,
                              'BlockPublicPolicy': True,
                              'RestrictPublicBuckets': True
                          }
                      )
                      print(f"âœ… Public access block configured for {bucket_name}")
                  except Exception as pab_error:
                      print(f"âš ï¸ Public access block configuration failed: {str(pab_error)}")
                      # ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºè¿™ä¸æ˜¯å…³é”®å¤±è´¥
                  
                  # å¯ç”¨ç‰ˆæœ¬æ§åˆ¶
                  try:
                      s3.put_bucket_versioning(
                          Bucket=bucket_name,
                          VersioningConfiguration={'Status': 'Enabled'}
                      )
                      print(f"âœ… Versioning enabled for {bucket_name}")
                  except Exception as version_error:
                      print(f"âš ï¸ Versioning configuration failed: {str(version_error)}")
                      # ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºè¿™ä¸æ˜¯å…³é”®å¤±è´¥
                  
                  return 'us-east-1'
                  
              except Exception as e:
                  print(f"âŒ S3 bucket creation/configuration error: {str(e)}")
                  # å¦‚æœæ˜¯é…ç½®é”™è¯¯ä½†bucketå­˜åœ¨ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
                  if "NoSuchBucket" not in str(e):
                      print(f"âš ï¸ Bucket may exist but configuration failed, continuing...")
                      return 'us-east-1'
                  raise

          def set_s3_bucket_policy(s3, bucket_name, account_id):
              """è®¾ç½®S3 Bucket Policyå…è®¸CURå†™å…¥"""
              bucket_policy = {
                  "Version": "2012-10-17",
                  "Statement": [
                      {
                          "Effect": "Allow",
                          "Principal": {
                              "Service": "billingreports.amazonaws.com"
                          },
                          "Action": [
                              "s3:GetBucketAcl",
                              "s3:GetBucketPolicy"
                          ],
                          "Resource": f"arn:aws:s3:::{bucket_name}",
                          "Condition": {
                              "StringEquals": {
                                  "aws:SourceAccount": account_id
                              }
                          }
                      },
                      {
                          "Effect": "Allow",
                          "Principal": {
                              "Service": "billingreports.amazonaws.com"
                          },
                          "Action": "s3:PutObject",
                          "Resource": f"arn:aws:s3:::{bucket_name}/*",
                          "Condition": {
                              "StringEquals": {
                                  "aws:SourceAccount": account_id
                              }
                          }
                      }
                  ]
              }
              
              try:
                  s3.put_bucket_policy(
                      Bucket=bucket_name,
                      Policy=json.dumps(bucket_policy)
                  )
                  print(f"Bucket policy set for {bucket_name}")
              except Exception as e:
                  print(f"Bucket policy error: {str(e)}")
                  raise

          def create_cur_export(cur, report_name, bucket_name, billing_group_arn):
              """åˆ›å»ºLegacy CUR Export with Pro forma pricing"""
              try:
                  # æ£€æŸ¥æŠ¥å‘Šæ˜¯å¦å·²å­˜åœ¨
                  try:
                      existing_reports = cur.describe_report_definitions()
                      for report in existing_reports['ReportDefinitions']:
                          if report['ReportName'] == report_name:
                              print(f"CUR report {report_name} already exists")
                              return f"arn:aws:cur:us-east-1::report/{report_name}"
                  except:
                      pass

                  print(f"Creating Legacy CUR with Pro forma pricing using BillingGroup: {billing_group_arn}")
                  
                  # ä»BillingGroup ARNä¸­æå–è´¦æˆ·IDï¼Œä½†ä½¿ç”¨æ­£ç¡®çš„BillingGroupåç§°
                  account_id = billing_group_arn.split(':')[4] if ':' in billing_group_arn else '000000000000'
                  
                  # æˆ‘ä»¬éœ€è¦è·å–å®é™…çš„BillingGroupåç§°ï¼Œè€Œä¸æ˜¯ä»ARNæå–çš„ID
                  # é¦–å…ˆå°è¯•ä»BillingConductor APIè·å–BillingGroupçš„å®é™…åç§°
                  import boto3
                  billingconductor = boto3.client('billingconductor')
                  
                  billing_group_name = "Bills"  # é»˜è®¤åç§°
                  try:
                      # å°è¯•è·å–BillingGroupçš„è¯¦ç»†ä¿¡æ¯æ¥è·å–æ­£ç¡®çš„åç§°
                      billing_groups = billingconductor.list_billing_groups()
                      for group in billing_groups.get('BillingGroups', []):
                          if group.get('Arn') == billing_group_arn:
                              billing_group_name = group.get('Name', 'Bills')
                              print(f"Found BillingGroup name from API: {billing_group_name}")
                              break
                      else:
                          print(f"BillingGroup not found in list, using default name: {billing_group_name}")
                  except Exception as bg_error:
                      print(f"Failed to get BillingGroup name from API: {str(bg_error)}, using default: {billing_group_name}")
                  
                  print(f"Using BillingGroup name: {billing_group_name}, Account ID: {account_id}")
                  
                  # å°è¯•åˆ›å»ºæˆ–æŸ¥æ‰¾å¯¹åº”çš„BillingView
                  try:
                      print("Attempting to create/find BillingView for the BillingGroup...")
                      billing_view_arn = create_or_find_billing_view(billingconductor, billing_group_arn, billing_group_name, account_id)
                      if billing_view_arn:
                          print(f"Found/created BillingView: {billing_view_arn}")
                      else:
                          print("No BillingView available, will use name-based approaches")
                  except Exception as billing_view_error:
                      print(f"BillingView creation failed: {str(billing_view_error)}")
                      billing_view_arn = None
                  
                  # å‡†å¤‡å°è¯•åˆ—è¡¨ï¼Œä¼˜å…ˆä½¿ç”¨æ„é€ çš„billing view ARN
                  billing_group_attempts = []
                  
                  # å¦‚æœæ‰¾åˆ°äº†billing view ARNï¼Œä¼˜å…ˆä½¿ç”¨å®ƒ
                  if billing_view_arn:
                      billing_group_attempts.append({'BillingViewArn': billing_view_arn})
                  
                  # æ·»åŠ å…¶ä»–å°è¯•æ–¹æ³•ï¼ŒåŸºäºAWSçš„æ­£åˆ™è¡¨è¾¾å¼è¦æ±‚
                  billing_group_attempts.extend([
                      # å°è¯•1: æ„é€ æ­£ç¡®çš„billing view ARNæ ¼å¼ï¼Œä½¿ç”¨æ­£ç¡®çš„BillingGroupåç§°
                      {'BillingViewArn': f"arn:aws:billing::{account_id}:billingview/{billing_group_name}"},
                      # å°è¯•2: ä»…ä½¿ç”¨BillingGroupåç§°ï¼ˆæœ€ç®€å•çš„æ ¼å¼ï¼‰
                      {'BillingViewArn': billing_group_name},
                      # å°è¯•3: å°è¯•ä¸åŒçš„åŒºåŸŸæ ¼å¼
                      {'BillingViewArn': f"arn:aws-cn:billing::{account_id}:billingview/{billing_group_name}"},
                      # å°è¯•4: å°è¯•æ²¡æœ‰ARNå‰ç¼€çš„æ ¼å¼ï¼Œåªç”¨åç§°
                      {'BillingViewArn': f"{billing_group_name}"},
                      # å°è¯•5: å°è¯•å°†IDä½œä¸ºåç§°ä½¿ç”¨ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
                      {'BillingViewArn': billing_group_arn.split('/')[-1]},
                      # å°è¯•6: å°è¯•ä¸æä¾›BillingViewArnå‚æ•°ï¼ˆå®Œå…¨çœç•¥ï¼‰
                      {}
                  ])
                  
                  print(f"Will attempt {len(billing_group_attempts)} different configurations")
                  
                  base_report_definition = {
                      'ReportName': report_name,
                      'TimeUnit': 'DAILY',
                      'Format': 'Parquet',
                      'Compression': 'Parquet',
                      'AdditionalSchemaElements': ['RESOURCES'],
                      'S3Bucket': bucket_name,
                      'S3Prefix': 'daily',
                      'S3Region': 'us-east-1',
                      'AdditionalArtifacts': ['ATHENA'],
                      'RefreshClosedReports': True,
                      'ReportVersioning': 'OVERWRITE_REPORT'
                  }
                  
                  last_error = None
                  
                  # å°è¯•ä¸åŒçš„BillingGroupå‚æ•°é…ç½®
                  for i, billing_param in enumerate(billing_group_attempts, 1):
                      try:
                          print(f"Attempt {i}: Using parameter {billing_param}")
                          report_definition = {**base_report_definition, **billing_param}
                          
                          response = cur.put_report_definition(ReportDefinition=report_definition)
                          print(f"âœ… CUR creation succeeded using {billing_param}")
                          
                          # éªŒè¯CURæ˜¯å¦çœŸçš„å…³è”äº†BillingGroup
                          time.sleep(2)  # ç­‰å¾…AWSå¤„ç†
                          created_reports = cur.describe_report_definitions()
                          for report in created_reports['ReportDefinitions']:
                              if report['ReportName'] == report_name:
                                  billing_view = report.get('BillingViewArn', 'NOT_SET')
                                  print(f"Created CUR verification - BillingViewArn: {billing_view}")
                                  
                                  # æ£€æŸ¥æˆ‘ä»¬ä½¿ç”¨çš„å‚æ•°æ˜¯å¦ä¸ç»“æœåŒ¹é…
                                  used_billing_view = billing_param.get('BillingViewArn', 'NOT_PROVIDED')
                                  print(f"Used parameter: {used_billing_view}, Got result: {billing_view}")
                                  
                                  # å¦‚æœæˆ‘ä»¬æä¾›äº†BillingViewArnä¸”ç»“æœåŒ¹é…ï¼ˆæˆ–è€…ç»“æœåŒ…å«Billsç­‰å…³é”®è¯ï¼‰
                                  if (used_billing_view != 'NOT_PROVIDED' and 
                                      (billing_view == used_billing_view or 
                                       (billing_view and billing_view != 'NOT_SET' and 'bills' in str(billing_view).lower()))):
                                      print(f"ğŸ‰ Successfully created Legacy CUR with Pro forma pricing!")
                                      print(f"Final BillingViewArn: {billing_view}")
                                      return f"arn:aws:cur:us-east-1::report/{report_name}"
                                  elif used_billing_view == 'NOT_PROVIDED':
                                      print(f"âš ï¸ CUR created without BillingViewArn parameter, checking if it's acceptable...")
                                      # å¯¹äºæ²¡æœ‰æä¾›BillingViewArnçš„æƒ…å†µï¼Œæˆ‘ä»¬æ¥å—ä½†ç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•
                                      print(f"ğŸ‰ CUR created successfully, will be standard pricing")
                                      return f"arn:aws:cur:us-east-1::report/{report_name}"
                                  else:
                                      print(f"âš ï¸ CUR created but BillingGroup association didn't work as expected. Trying next method...")
                                      # åˆ é™¤è¿™ä¸ªä¸æ­£ç¡®çš„æŠ¥å‘Šå¹¶å°è¯•ä¸‹ä¸€ä¸ªæ–¹æ³•
                                      try:
                                          cur.delete_report_definition(ReportName=report_name)
                                          print(f"Deleted incorrect CUR to try next method")
                                      except:
                                          pass
                                      break
                          continue
                          
                      except Exception as e:
                          last_error = str(e)
                          print(f"âŒ Attempt {i} failed: {last_error}")
                          continue
                  
                  # å¦‚æœæ‰€æœ‰å°è¯•éƒ½å¤±è´¥ï¼Œåˆ›å»ºä¸å¸¦BillingGroupçš„æ ‡å‡†CUR
                  print("All BillingGroup attempts failed, creating standard CUR without Pro forma pricing")
                  try:
                      response = cur.put_report_definition(ReportDefinition=base_report_definition)
                      print(f"âš ï¸ Created standard CUR without Pro forma pricing. BillingGroup: {billing_group_arn}")
                      return f"arn:aws:cur:us-east-1::report/{report_name}"
                  except Exception as standard_error:
                      print(f"Even standard CUR creation failed: {str(standard_error)}")
                      raise Exception(f"Failed to create CUR. Last BillingGroup error: {last_error}, Standard CUR error: {str(standard_error)}")
                  
              except Exception as e:
                  print(f"CUR creation error: {str(e)}")
                  raise

          def create_or_find_billing_view(billingconductor, billing_group_arn, billing_group_name, account_id):
              """å°è¯•åˆ›å»ºæˆ–æŸ¥æ‰¾å¯¹åº”çš„BillingView"""
              try:
                  # BillingConductorå¯èƒ½ä¸ç›´æ¥æä¾›BillingView API
                  # ä½†æˆ‘ä»¬å¯ä»¥å°è¯•æ„é€ æ­£ç¡®çš„ARNæ ¼å¼
                  
                  # å°è¯•ä¸åŒçš„å¯èƒ½çš„billing view ARNæ ¼å¼
                  possible_arns = [
                      f"arn:aws:billing::{account_id}:billingview/{billing_group_name}",
                      f"arn:aws:billingconductor::{account_id}:billingview/{billing_group_name}",
                      f"arn:aws:billing::us-east-1:{account_id}:billingview/{billing_group_name}",
                      billing_group_name  # ç®€å•åç§°
                  ]
                  
                  for arn in possible_arns:
                      print(f"Testing potential BillingView ARN: {arn}")
                  
                  # ç”±äºæ²¡æœ‰ç›´æ¥çš„APIæ¥éªŒè¯BillingViewï¼Œæˆ‘ä»¬è¿”å›æœ€å¯èƒ½çš„æ ¼å¼
                  preferred_arn = f"arn:aws:billing::{account_id}:billingview/{billing_group_name}"
                  print(f"Using preferred BillingView ARN format: {preferred_arn}")
                  return preferred_arn
                  
              except Exception as e:
                  print(f"Error in create_or_find_billing_view: {str(e)}")
                  return None

  # Custom Resourceè§¦å‘Lambda
  CreateLegacyCURExport:
    Type: Custom::CreateLegacyCURExport
    Properties:
      ServiceToken: !GetAtt CreateCURExportFunction.Arn
      BillingGroupArn: !Ref BillingGroupArn

Outputs:
  BucketName:
    Description: "Name of the S3 bucket for CUR data"
    Value: !GetAtt CreateLegacyCURExport.BucketName
    Export:
      Name: !Sub "${AWS::StackName}-CURBucketName"

  BucketRegion:
    Description: "Region of the S3 bucket"
    Value: !GetAtt CreateLegacyCURExport.BucketRegion
    Export:
      Name: !Sub "${AWS::StackName}-CURBucketRegion"

  ReportName:
    Description: "Name of the CUR report"
    Value: !GetAtt CreateLegacyCURExport.ReportName
    Export:
      Name: !Sub "${AWS::StackName}-CURReportName"

  CURArn:
    Description: "ARN of the CUR report"
    Value: !GetAtt CreateLegacyCURExport.CURArn
    Export:
      Name: !Sub "${AWS::StackName}-CURArn"

  BillingGroupArn:
    Description: "ARN of the BillingGroup for Pro forma pricing"
    Value: !GetAtt CreateLegacyCURExport.BillingGroupArn
    Export:
      Name: !Sub "${AWS::StackName}-BillingGroupArn"